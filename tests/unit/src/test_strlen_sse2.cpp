#include "interpreter/vm.h"
#include "interpreter/thread.h"
#include "interpreter/verify.h"
#include "fmt/core.h"
#include <vector>

std::vector<unsigned char> strlen_sse2 {{
    0x66, 0x0f, 0xef, 0xc0, 0x66, 0x0f, 0xef, 0xc9, 0x66, 0x0f, 0xef, 0xd2, 0x66, 0x0f, 0xef, 0xdb,
    0x48, 0x89, 0xf8, 0x48, 0x89, 0xf9, 0x48, 0x81, 0xe1, 0xff, 0x0f, 0x00, 0x00, 0x48, 0x81, 0xf9,
    0xcf, 0x0f, 0x00, 0x00, 0x77, 0x6a, 0xf3, 0x0f, 0x6f, 0x20, 0x66, 0x0f, 0x74, 0xe0, 0x66, 0x0f,
    0xd7, 0xd4, 0x85, 0xd2, 0x74, 0x04, 0x0f, 0xbc, 0xc2, 0xc3, 0x48, 0x83, 0xe0, 0xf0, 0x66, 0x0f,
    0x74, 0x48, 0x10, 0x66, 0x0f, 0x74, 0x50, 0x20, 0x66, 0x0f, 0x74, 0x58, 0x30, 0x66, 0x0f, 0xd7,
    0xd1, 0x66, 0x44, 0x0f, 0xd7, 0xc2, 0x66, 0x0f, 0xd7, 0xcb, 0x48, 0xc1, 0xe2, 0x10, 0x48, 0xc1,
    0xe1, 0x10, 0x4c, 0x09, 0xc1, 0x48, 0xc1, 0xe1, 0x20, 0x48, 0x09, 0xca, 0x48, 0x89, 0xf9, 0x48,
    0x31, 0xc1, 0x48, 0x83, 0xe0, 0xc0, 0x48, 0xd3, 0xfa, 0x48, 0x85, 0xd2, 0x0f, 0x84, 0x7e, 0x00,
    0x00, 0x00, 0x48, 0x0f, 0xbc, 0xc2, 0xc3, 0x66, 0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x48, 0x83, 0xe0, 0xc0, 0x66, 0x0f, 0x74, 0x00, 0x66, 0x0f, 0x74, 0x48, 0x10, 0x66, 0x0f, 0x74,
    0x50, 0x20, 0x66, 0x0f, 0x74, 0x58, 0x30, 0x66, 0x0f, 0xd7, 0xf0, 0x66, 0x0f, 0xd7, 0xd1, 0x66,
    0x44, 0x0f, 0xd7, 0xc2, 0x66, 0x0f, 0xd7, 0xcb, 0x48, 0xc1, 0xe2, 0x10, 0x48, 0xc1, 0xe1, 0x10,
    0x48, 0x09, 0xf2, 0x4c, 0x09, 0xc1, 0x48, 0xc1, 0xe1, 0x20, 0x48, 0x09, 0xca, 0x48, 0x89, 0xf9,
    0x48, 0x31, 0xc1, 0x48, 0x83, 0xe0, 0xc0, 0x48, 0xd3, 0xfa, 0x48, 0x85, 0xd2, 0x74, 0x11, 0x48,
    0x0f, 0xbc, 0xc2, 0xc3, 0x66, 0x66, 0x2e, 0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90,
    0x66, 0x0f, 0xef, 0xc9, 0x66, 0x0f, 0xef, 0xd2, 0x66, 0x0f, 0xef, 0xdb, 0x0f, 0x1f, 0x40, 0x00,
    0x66, 0x0f, 0x6f, 0x40, 0x40, 0x66, 0x0f, 0xda, 0x40, 0x50, 0x66, 0x0f, 0xda, 0x40, 0x60, 0x66,
    0x0f, 0xda, 0x40, 0x70, 0x66, 0x0f, 0x74, 0xc3, 0x66, 0x0f, 0xd7, 0xd0, 0x85, 0xd2, 0x75, 0x30,
    0x48, 0x83, 0xe8, 0x80, 0x66, 0x0f, 0x6f, 0x00, 0x66, 0x0f, 0xda, 0x40, 0x10, 0x66, 0x0f, 0xda,
    0x40, 0x20, 0x66, 0x0f, 0xda, 0x40, 0x30, 0x66, 0x0f, 0x74, 0xc3, 0x66, 0x0f, 0xd7, 0xd0, 0x85,
    0xd2, 0x75, 0x11, 0xeb, 0xbb, 0x66, 0x66, 0x2e, 0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x48, 0x83, 0xc0, 0x40, 0x66, 0x0f, 0xef, 0xc0, 0x66, 0x0f, 0x74, 0x00, 0x66, 0x0f, 0x74, 0x48,
    0x10, 0x66, 0x0f, 0x74, 0x50, 0x20, 0x66, 0x0f, 0x74, 0x58, 0x30, 0x66, 0x0f, 0xd7, 0xf0, 0x66,
    0x0f, 0xd7, 0xd1, 0x66, 0x44, 0x0f, 0xd7, 0xc2, 0x66, 0x0f, 0xd7, 0xcb, 0x48, 0xc1, 0xe2, 0x10,
    0x48, 0xc1, 0xe1, 0x10, 0x48, 0x09, 0xf2, 0x4c, 0x09, 0xc1, 0x48, 0xc1, 0xe1, 0x20, 0x48, 0x09,
    0xca, 0x48, 0x0f, 0xbc, 0xd2, 0x48, 0x01, 0xd0, 0x48, 0x29, 0xf8, 0xc3, 0x0f, 0x1f, 0x40, 0x00
}};

std::vector<char> string {{
    'h', 'e', 'l', 'l', 'o', '!', '\0'
}};

int main() {
    using namespace x64;
    Mmu mmu;

    u64 length = 0;

    bool errorEncountered = false;

    VerificationScope::run([&]() {
        u64 execPage = mmu.mmap(0, Mmu::PAGE_SIZE, PROT::READ | PROT::WRITE | PROT::EXEC, MAP::PRIVATE | MAP::ANONYMOUS, 0, 0);
        mmu.copyToMmu(Ptr8{execPage}, strlen_sse2.data(), strlen_sse2.size());
        mmu.mprotect(execPage, Mmu::PAGE_SIZE, PROT::READ | PROT::EXEC);

        u64 dataPage = mmu.mmap(0, Mmu::PAGE_SIZE, PROT::READ | PROT::WRITE, MAP::PRIVATE | MAP::ANONYMOUS, 0, 0);
        mmu.copyToMmu(Ptr8{dataPage}, (const u8*)string.data(), string.size());

        VM vm(&mmu, nullptr);
        vm.setLogInstructions(true);
        Thread mainThread(0, 0);
        mainThread.data.regs.rip() = execPage;
        mainThread.data.regs.set(R64::RDI, dataPage);
        mainThread.ticksUntilSwitch = 1'000'000;
        vm.execute(&mainThread);
        length = mainThread.data.regs.get(R64::RAX);
    }, [&]() {
        errorEncountered = true;
    });

    if(errorEncountered) return 1;

    fmt::print("Test string       : \"{}\"\n", string.data());
    fmt::print("VM computed length: {}\n", length);
    fmt::print("Actual length     : {}\n", strlen(string.data()));

    if(length != 6) return 1;
    return 0;
}